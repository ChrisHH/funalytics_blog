{
  "hash": "c55a3380977e20917f52fde022ba8fad",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Flight LH402 (FRA - EWR)\"\ndraft: true\nauthor: Christian Jaehnert\ndate: '2025-12-14'\nformat: html\nslug: \ncategories:\n  - R\n  - ggplot\n  - tidyverse\n  - aviation\n  - FRA\n  - EWR\n  - flights\ntags:\n  - R\n  - ggplot\n  - aviation\n  - travel\n  \nsummary: \"I analyze which plane will be used.\"\n---\n\n# Flight LH402\n\nSoon I will be heading for New York for the X-Mas break. I will be flying from Hamburg to Newark (EWR) via Frankfurt (FRA) with Lufthansa. On the leg from FRA-EWR Lufthansa is operating with the queen of the skies, the legend Boeing 747.\n\nIn this short post, I will check which airplane I will most likely fly with.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.6.0\n✔ ggplot2   4.0.1     ✔ tibble    3.3.0\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.2.0     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(janitor)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'janitor'\n\nThe following objects are masked from 'package:stats':\n\n    chisq.test, fisher.test\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(lubridate)\n\ndata <- read_xlsx(\"input/LH402.xlsx\") |> \n  clean_names() |> \n  select(-unnamed_8, -unnamed_10, -date)\n\n\ndata <- data |> \n  mutate(datum = as.Date(datum, format = \"%d.%m.%Y\")) |> \n  filter(datum < \"2025-12-14\")\n\ndata <- data |> \n  mutate(registration = str_extract(aircraft, \"(?<=\\\\().*(?=\\\\))\")) |> \n  select(-aircraft)\n\ndata <- data |>\n  mutate(\n    date0 = as_datetime(ymd(datum), tz = \"Europe/Berlin\"),\n    std = lubridate::hms(std) + date0,\n    atd = lubridate::hms(atd) + date0,\n    sta = lubridate::hms(sta) + date0,\n    ata = lubridate::hm(str_extract(status, \"\\\\d{2}:\\\\d{2}\")) + date0,\n    flight_time = lubridate::hms(flight_time),\n    dep_delay_min = as.numeric(difftime(atd, std, units = \"mins\")),\n    arr_delay_min = as.numeric(difftime(ata, sta, units = \"mins\")),\n    dow = wday(datum, label = TRUE, week_start = 1),\n    month = floor_date(datum, \"month\")\n  ) |>\n  select(-status, -date0)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |> \n  summarise(\n    # flight_time → numeric (Sekunden) → Mittelwert → wieder Period\n    mean_flight_time = seconds_to_period(mean(as.numeric(flight_time), na.rm = TRUE))\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  mean_flight_time        \n  <Period>                \n1 7H 54M 24.5303867403309S\n```\n\n\n:::\n\n```{.r .cell-code}\ndata %>%\n  mutate(month = floor_date(datum, \"month\")) %>%\n  group_by(month) %>%\n  summarise(\n    mean_flight_time_sec = mean(as.numeric(flight_time), na.rm = TRUE)\n  ) %>%\n  mutate(mean_flight_time_hours = mean_flight_time_sec / 3600) %>%  # Sek → Stunden\n  ggplot(aes(x = month, y = mean_flight_time_hours)) +\n  geom_col() +\n  labs(\n    y = \"Mittlere Flugzeit (Stunden)\",\n    x = \"Monat\",\n    title = \"Mittlere Flugzeit pro Monat\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndata %>%\n  group_by(registration) %>%\n  summarise(\n    mean_flight_time_sec = mean(as.numeric(flight_time), na.rm = TRUE)\n  ) %>%\n  mutate(mean_flight_time_hours = mean_flight_time_sec / 3600) %>%  # Sek → Stunden\n  mutate(registration = fct_reorder(registration, mean_flight_time_hours)) |> \n  ggplot(aes(x = registration, y = mean_flight_time_hours)) +\n  geom_col() +\n  labs(\n    y = \"Mittlere Flugzeit (Stunden)\",\n    x = \"Monat\",\n    title = \"Mittlere Flugzeit pro Monat\"\n  ) +\n  theme_minimal() +\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-2.png){width=672}\n:::\n\n```{.r .cell-code}\ndata %>%\n  mutate(month = floor_date(datum, \"month\")) %>%\n  group_by(datum) |> \n  count(registration) |> \n  ggplot(aes(x = datum, y = n, group = registration, color = registration))+\n  geom_point() +\n  geom_line() +\n  facet_wrap(vars(registration))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_line()`: Each group consists of only one observation.\nℹ Do you need to adjust the group aesthetic?\n`geom_line()`: Each group consists of only one observation.\nℹ Do you need to adjust the group aesthetic?\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-3.png){width=672}\n:::\n\n```{.r .cell-code}\ndata |> \n  count(registration, sort = TRUE) |> \n  mutate(share = n / sum(n))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 22 × 3\n   registration     n  share\n   <chr>        <int>  <dbl>\n 1 D-ABYG          28 0.0773\n 2 D-ABYJ          27 0.0746\n 3 D-ABYC          25 0.0691\n 4 D-ABYH          24 0.0663\n 5 D-ABYK          24 0.0663\n 6 D-ABYI          23 0.0635\n 7 D-ABYA          22 0.0608\n 8 D-ABYL          22 0.0608\n 9 D-ABYM          21 0.0580\n10 D-ABYQ          21 0.0580\n# ℹ 12 more rows\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata |>\n  summarise(\n    flights = n(),\n    first_date = min(datum, na.rm = TRUE),\n    last_date  = max(datum, na.rm = TRUE),\n    registrations = n_distinct(registration),\n    mean_dep_delay_min = mean(dep_delay_min, na.rm = TRUE),\n    mean_arr_delay_min = mean(arr_delay_min, na.rm = TRUE),\n    share_arrived_within_15min = mean(arr_delay_min <= 15, na.rm = TRUE)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 7\n  flights first_date last_date  registrations mean_dep_delay_min\n    <int> <date>     <date>             <int>              <dbl>\n1     362 2024-12-14 2025-12-13            22               44.5\n# ℹ 2 more variables: mean_arr_delay_min <dbl>,\n#   share_arrived_within_15min <dbl>\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreg_counts <- data |>\n  count(registration, sort = TRUE) |>\n  mutate(share = n / sum(n))\n\n\nreg_counts |>\n  slice_head(n = 10) |>\n  ggplot(aes(x = fct_reorder(registration, n), y = n)) +\n  geom_col() +\n  coord_flip() +\n  labs(\n    title = \"LH402: most frequent registrations\",\n    x = NULL,\n    y = \"Number of flights in sample\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict_from_last_n <- function(df, n_last = 20) {\n  df |>\n    arrange(datum) |>\n    slice_tail(n = n_last) |>\n    count(registration, sort = TRUE) |>\n    mutate(share = n / sum(n), window = paste0(\"last_\", n_last))\n}\n\npred_10 <- predict_from_last_n(data, 10)\npred_20 <- predict_from_last_n(data, 20)\npred_30 <- predict_from_last_n(data, 30)\n\nbind_rows(pred_10, pred_20, pred_30) |>\n  group_by(window) |>\n  slice_head(n = 5) |>\n  ungroup()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 15 × 4\n   registration     n share window \n   <chr>        <int> <dbl> <chr>  \n 1 D-ABYC           2 0.2   last_10\n 2 D-ABYD           1 0.1   last_10\n 3 D-ABYI           1 0.1   last_10\n 4 D-ABYK           1 0.1   last_10\n 5 D-ABYM           1 0.1   last_10\n 6 D-ABYC           4 0.2   last_20\n 7 D-ABYQ           3 0.15  last_20\n 8 D-ABYI           2 0.1   last_20\n 9 D-ABYO           2 0.1   last_20\n10 D-ABYS           2 0.1   last_20\n11 D-ABYC           4 0.133 last_30\n12 D-ABYQ           4 0.133 last_30\n13 D-ABYO           3 0.1   last_30\n14 D-ABYR           3 0.1   last_30\n15 D-ABYS           3 0.1   last_30\n```\n\n\n:::\n\n```{.r .cell-code}\nbind_rows(pred_10, pred_20, pred_30) |>\n  slice_max(share, n = 8, with_ties = TRUE) |>\n  ggplot(aes(x = fct_reorder(registration, share), y = share, fill = window)) +\n  geom_col(position = \"dodge\") +\n  coord_flip() +\n  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n  labs(\n    title = \"Most likely aircraft by recent windows\",\n    x = NULL,\n    y = \"Share of flights\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstability <- data |>\n  arrange(datum) |>\n  mutate(reg_next = lead(registration)) |>\n  summarise(\n    prob_same_next_flight = mean(registration == reg_next, na.rm = TRUE)\n  )\n\n\nstability\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  prob_same_next_flight\n                  <dbl>\n1                0.0443\n```\n\n\n:::\n\n```{.r .cell-code}\ntransitions <- data |>\n  arrange(datum) |>\n  mutate(reg_next = lead(registration)) |>\n  filter(!is.na(reg_next)) |>\n  count(registration, reg_next, sort = TRUE)\n\n\n\ntransitions |>\n  group_by(registration) |>\n  mutate(p = n / sum(n)) |>\n  ungroup() |>\n  slice_max(p, n = 1, with_ties = FALSE) |>\n  arrange(desc(p)) |>\n  ggplot(aes(x = fct_reorder(registration, p), y = p)) +\n  geom_col() +\n  coord_flip() +\n  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n  labs(\n    title = \"For each registration: most likely next registration\",\n    x = NULL,\n    y = \"Transition probability\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noverall <- data |>\n  count(registration, sort = TRUE) |>\n  mutate(overall_share = n / sum(n)) |>\n  select(registration, overall_share)\n\nrecent20 <- predict_from_last_n(data, 20) |>\n  select(registration, recent_share = share)\n\npick <- full_join(overall, recent20, by = \"registration\") |>\n  replace_na(list(overall_share = 0, recent_share = 0)) |>\n  mutate(score = 0.5 * overall_share + 0.5 * recent_share) |>\n  arrange(desc(score))\n\npick |> slice_head(n = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 4\n   registration overall_share recent_share  score\n   <chr>                <dbl>        <dbl>  <dbl>\n 1 D-ABYC              0.0691         0.2  0.135 \n 2 D-ABYQ              0.0580         0.15 0.104 \n 3 D-ABYI              0.0635         0.1  0.0818\n 4 D-ABYS              0.0470         0.1  0.0735\n 5 D-ABYO              0.0359         0.1  0.0680\n 6 D-ABYH              0.0663         0.05 0.0581\n 7 D-ABYK              0.0663         0.05 0.0581\n 8 D-ABYM              0.0580         0.05 0.0540\n 9 D-ABYD              0.0525         0.05 0.0512\n10 D-ABYR              0.0442         0.05 0.0471\n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}